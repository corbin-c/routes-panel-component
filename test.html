<!DOCTYPE html>
<html>
  <head>
    <title>Canvas / Bezier Curves test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
* {
  margin: 0;
  padding: 0;
  font-family: Sans;
  box-sizing: border-box;
}
li {
  line-height: 20px;
  width: 100%;
  height: 20px; //to be handled dynamically w/ const LINE_HEIGHT
}
.inputs {
  text-align: right;
}
ul {
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
  align-items: flex-start;
  list-style: none;
}
  </style>
  </head>
  <body>
    <header><h1>Bezier</h1></header>
    <main>
    </main>
    <footer>
    </footer>
  <script type="module">
const LINE_HEIGHT = 20;
const RADIUS = 5;
const COLOR = "blue";

function findElementInParent(target) {
  return [...target.parentElement.childNodes].indexOf(target);
}
function setOutput(target,callback) {
  if (internal_state !== false) {
    if (typeof target === "object") {
    target = findElementInParent(target);
    }
    drawBezier(inputs[internal_state],outputs[target],context2d);
    callback(internal_state,target);
    routes.push([internal_state,target]);
    internal_state = false;
  }
}
function findPoint(points,coordinates) {
  return points.indexOf(points.find(i => {
    let rangeX = [i.x-RADIUS,i.x+RADIUS];
    let rangeY = [i.y-RADIUS,i.y+RADIUS];
    return (((coordinates.x >= rangeX[0])
      && (coordinates.x <= rangeX[1])) 
      && ((coordinates.y >= rangeY[0])
      && (coordinates.y <= rangeY[1])));
  }));
}
function findPointOnCanvas(event,canvas) {
  let coords = {
    x:event.pageX - canvas.offsetLeft,
    y:event.pageY - canvas.offsetTop
  };
  return [findPoint(inputs,coords),findPoint(outputs,coords)];
}

let Router = class {
  constructor(in_string,out_string) {
    this.routes = [];
    this.internal_state = false;
    this.canvas = document.createElement("canvas");
    this.context = this.canvas.getContext("2d");
    this.inputs = in_string.split(",");
    this.outputs = out_string.split(",");
    this.ul_elts = [document.createElement("ul"),document.createElement("ul")];
    this.container = document.createElement("div");
    this.container.setAttribute("style","display:flex;");
    this.ul_elts[0].setAttribute("class","inputs");
    this.fillLists();
    this.container.append(this.ul_elts[0]);
    this.canvas.height =
      LINE_HEIGHT*(Math.max(this.inputs.length,this.outputs.length));
    this.container.append(this.canvas);
    this.container.append(this.ul_elts[1]);
    this.computePoints();
    this.drawAgain();
  }
  fillLists() {
    [this.inputs,this.outputs].map((array,i) => { 
        array.map(e => {
        let li = document.createElement("li");
        li.innerHTML = e;
        this.ul_elts[i].append(li);
      });
    });
  }
  computePoints() {
    let compute = (array,base_x) => {
      let y_span = this.canvas.height/array.length;
      return array.map((e,i) => ({x:base_x,y:0.5*y_span+i*y_span}));
    }
    this.inputs = compute(this.inputs,RADIUS);
    this.outputs = compute(this.outputs,this.canvas.width-RADIUS);
  }
  drawPoints() {
    this.context.fillStyle = COLOR;
    [this.inputs,this.outputs].map(f => {
      this.context.beginPath();
      f.map(e => {
        this.context.arc(e.x, e.y, RADIUS, 0, 2*Math.PI);
      });
      this.context.fill();
    });
  }
  drawBezier(context) {
    let controls = [
      {x:input.x+(output.x-input.x)/2,y:input.y+0.25*(output.y-input.y)},
      {x:input.x+(output.x-input.x)/2,y:input.y+0.75*(output.y-input.y)}
    ];
    this.context.beginPath();
    this.context.moveTo(input.x, input.y);
    this.context.bezierCurveTo(
      controls[0].x, controls[0].y,
      controls[1].x, controls[1].y,
      output.x, output.y
    );
    this.context.stroke();
  }
  drawAgain() {
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    this.drawPoints();
    this.routes.map(e => this.drawBezier(this.inputs[e[0]],this.outputs[e[1]]));
  }
};
let route = new Router("comma,separated,values","again,comma,separated,values");
document.querySelector("main").append(route.container);
/*ul_in.addEventListener("click",(e) => {
  internal_state = findElementInParent(e.target);
});
ul_out.addEventListener("click",(e) => {
  setOutput(e.target,console.log);
});
canvas.addEventListener("click",(e) => {
  let point = findPointOnCanvas(e,canvas);
  if (point[0] != -1) {
    internal_state = point[0];
  } else if (point[1] != -1) {
    setOutput(point[1],console.log);
  }
});
canvas.addEventListener("contextmenu",(e) => {
  e.preventDefault();
  let point = findPointOnCanvas(e,canvas);
  point.map((e,i) => {
    if (e != -1) {
      routes = routes.filter(e => e[i] != point[i]);
    }
  });
  drawAgain();
});
ul_in.addEventListener("contextmenu",(e) => {
  e.preventDefault();
  let point = findElementInParent(e.target);
  routes = routes.filter(e => e[0] != point);
  drawAgain();
});
ul_out.addEventListener("contextmenu",(e) => {
  e.preventDefault();
  let point = findElementInParent(e.target);
  routes = routes.filter(e => e[1] != point);
  drawAgain();
});*/
  </script>
  </body>
</html>
